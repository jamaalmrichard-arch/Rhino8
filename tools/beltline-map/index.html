<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhino8 | Atlanta Westside Investment Map — Full Coverage</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --gold: #c8a84e;
    --gold-light: #e0c872;
    --gold-dim: #8a7535;
    --dark: #0a0a0a;
    --dark-card: #141414;
    --dark-surface: #1a1a1a;
    --dark-border: #2a2a2a;
    --text: #e0e0e0;
    --text-dim: #888;
    --green: #00e676;
    --yellow: #ffd740;
    --orange: #ff9100;
    --red: #ff5252;
    --blue: #448aff;
    --purple: #b388ff;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--dark);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* HEADER */
  #header {
    height: 52px;
    background: linear-gradient(135deg, #0e0e0e 0%, #1a1a1a 100%);
    border-bottom: 1px solid var(--dark-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
    position: relative;
  }
  #header .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #header .brand .logo {
    width: 28px;
    height: 28px;
    background: var(--gold);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 14px;
    color: var(--dark);
  }
  #header .brand h1 {
    font-size: 15px;
    font-weight: 600;
    color: var(--gold);
    letter-spacing: 0.5px;
  }
  #header .brand h1 span {
    color: var(--text-dim);
    font-weight: 400;
    margin-left: 8px;
    font-size: 13px;
  }
  #header .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }
  #addressSearch {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--text);
    padding: 6px 36px 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    width: 280px;
    transition: all 0.2s;
  }
  #addressSearch:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(200,168,78,0.15);
  }
  #addressSearch::placeholder { color: var(--text-dim); }
  .search-btn {
    position: absolute;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--gold);
    border: none;
    color: var(--dark);
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .search-btn:hover { background: var(--gold-light); }
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 0 0 6px 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 2000;
    display: none;
  }
  .search-results.active { display: block; }
  .search-result-item {
    padding: 8px 12px;
    font-size: 12px;
    color: var(--text);
    cursor: pointer;
    border-bottom: 1px solid var(--dark-border);
    transition: background 0.15s;
  }
  .search-result-item:hover { background: var(--dark-surface); color: var(--gold); }
  .search-result-item:last-child { border-bottom: none; }
  .search-loading { padding: 10px 12px; font-size: 11px; color: var(--text-dim); text-align: center; }
  .header-btn {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--text);
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .header-btn:hover {
    border-color: var(--gold-dim);
    color: var(--gold);
  }
  .header-btn.gold {
    background: var(--gold);
    color: var(--dark);
    border-color: var(--gold);
    font-weight: 600;
  }
  .header-btn.gold:hover {
    background: var(--gold-light);
  }

  /* MAP */
  #map {
    height: calc(100vh - 52px);
    width: 100%;
    background: #0a0a0a;
  }

  /* Override Leaflet controls */
  .leaflet-control-layers {
    background: var(--dark-card) !important;
    border: 1px solid var(--dark-border) !important;
    border-radius: 8px !important;
    color: var(--text) !important;
    padding: 8px 12px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
    max-height: 80vh !important;
    overflow-y: auto !important;
  }
  .leaflet-control-layers-toggle {
    background-color: var(--dark-card) !important;
    border: 1px solid var(--dark-border) !important;
    border-radius: 8px !important;
    width: 36px !important;
    height: 36px !important;
  }
  .leaflet-control-layers label {
    color: var(--text) !important;
    font-size: 12px !important;
    font-family: 'Inter', sans-serif !important;
  }
  .leaflet-control-layers-separator {
    border-top-color: var(--dark-border) !important;
  }
  .leaflet-control-zoom a {
    background: var(--dark-card) !important;
    color: var(--gold) !important;
    border-color: var(--dark-border) !important;
    font-size: 16px !important;
    width: 34px !important;
    height: 34px !important;
    line-height: 34px !important;
  }
  .leaflet-control-zoom a:hover {
    background: var(--dark-surface) !important;
    color: var(--gold-light) !important;
  }
  .leaflet-control-zoom {
    border: none !important;
    border-radius: 8px !important;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
  }
  .leaflet-control-attribution {
    background: rgba(10,10,10,0.85) !important;
    color: var(--text-dim) !important;
    font-size: 10px !important;
  }
  .leaflet-control-attribution a {
    color: var(--gold-dim) !important;
  }

  /* Popups */
  .leaflet-popup-content-wrapper {
    background: var(--dark-card) !important;
    color: var(--text) !important;
    border: 1px solid var(--dark-border) !important;
    border-radius: 10px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6) !important;
  }
  .leaflet-popup-tip {
    background: var(--dark-card) !important;
    border: 1px solid var(--dark-border) !important;
  }
  .leaflet-popup-close-button {
    color: var(--text-dim) !important;
    font-size: 18px !important;
  }
  .leaflet-popup-close-button:hover {
    color: var(--gold) !important;
  }
  .leaflet-popup-content {
    margin: 12px 16px !important;
    font-family: 'Inter', sans-serif !important;
    font-size: 13px !important;
    line-height: 1.5 !important;
  }

  /* Popup content styles */
  .popup-title {
    font-weight: 700;
    font-size: 14px;
    color: var(--gold);
    margin-bottom: 6px;
  }
  .popup-subtitle {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .popup-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid var(--dark-border);
    font-size: 12px;
  }
  .popup-row:last-child { border-bottom: none; }
  .popup-label { color: var(--text-dim); }
  .popup-value { color: var(--text); font-weight: 500; }

  /* Property form popup */
  .prop-form { min-width: 320px; }
  .prop-form .popup-title { margin-bottom: 10px; }
  .prop-form label {
    display: block;
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 3px;
    margin-top: 8px;
  }
  .prop-form input, .prop-form textarea, .prop-form select {
    width: 100%;
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 5px;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .prop-form input:focus, .prop-form textarea:focus, .prop-form select:focus {
    border-color: var(--gold-dim);
  }
  .prop-form textarea { resize: vertical; height: 50px; }
  .prop-form .arv-display {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    padding: 6px 10px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 4px;
  }
  .prop-form .form-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .prop-form .btn-save {
    flex: 1;
    background: var(--gold);
    color: var(--dark);
    border: none;
    padding: 8px;
    border-radius: 5px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
  }
  .prop-form .btn-save:hover { background: var(--gold-light); }
  .prop-form .btn-cancel {
    flex: 1;
    background: var(--dark-surface);
    color: var(--text-dim);
    border: 1px solid var(--dark-border);
    padding: 8px;
    border-radius: 5px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
  }
  .prop-form .btn-cancel:hover { color: var(--text); border-color: #444; }
  .prop-form .btn-delete {
    background: transparent;
    color: var(--red);
    border: 1px solid var(--red);
    padding: 8px;
    border-radius: 5px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    margin-top: 8px;
    width: 100%;
  }
  .prop-form .section-divider {
    border: none;
    border-top: 1px solid var(--dark-border);
    margin: 14px 0 8px 0;
  }
  .prop-form .section-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }
  .prop-form .grid-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .prop-form .grid-3col {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }
  .prop-form .grid-cell label {
    margin-top: 0;
  }
  .rental-summary {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 6px;
    padding: 10px 12px;
    margin-top: 10px;
    font-size: 11px;
  }
  .rental-summary .rs-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }
  .rental-summary .rs-row {
    display: flex;
    justify-content: space-between;
    padding: 2px 0;
    border-bottom: 1px solid rgba(42,42,42,0.5);
  }
  .rental-summary .rs-row:last-child { border-bottom: none; }
  .rental-summary .rs-row.rs-highlight {
    font-weight: 700;
    padding: 4px 0;
    border-bottom: none;
    margin-top: 4px;
    border-top: 1px solid var(--dark-border);
    padding-top: 6px;
  }
  .rental-summary .rs-label { color: var(--text-dim); }
  .rental-summary .rs-value { color: var(--text); font-weight: 500; }

  /* LEGEND */
  .legend-panel {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 14px 18px;
    z-index: 1001;
    min-width: 210px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }
  .legend-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 5px;
  }
  .legend-color {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .legend-line {
    width: 14px;
    height: 3px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  .legend-line-dashed {
    width: 14px;
    height: 0px;
    border-top: 3px dashed;
    flex-shrink: 0;
  }
  .legend-ring {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid;
    background: transparent;
  }
  .legend-circle {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* INFO PANEL -- hover proximity */
  .info-panel {
    position: fixed;
    top: 62px;
    right: 20px;
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 14px 18px;
    z-index: 1001;
    min-width: 250px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    display: none;
  }
  .info-panel.active { display: block; }
  .info-panel .info-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .info-panel .info-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    padding: 3px 0;
  }
  .info-panel .info-label { color: var(--text-dim); }
  .info-panel .info-value { color: var(--text); font-weight: 500; }
  .info-panel .score-bar {
    margin-top: 10px;
    height: 6px;
    background: var(--dark-surface);
    border-radius: 3px;
    overflow: hidden;
  }
  .info-panel .score-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s;
  }
  .info-panel .score-label {
    font-size: 11px;
    margin-top: 4px;
    font-weight: 600;
  }

  /* FILTER PANEL */
  .filter-panel {
    position: fixed;
    top: 62px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 10px 16px;
    z-index: 1001;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    gap: 12px;
  }
  .filter-panel.active { display: flex; }
  .filter-panel label {
    font-size: 11px;
    color: var(--text-dim);
    white-space: nowrap;
  }
  .filter-panel select {
    background: var(--dark-surface);
    border: 1px solid var(--dark-border);
    color: var(--text);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    outline: none;
  }
  .filter-panel .close-filter {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
  }
  .filter-panel .close-filter:hover { color: var(--text); }

  /* ADD PROPERTY MODE INDICATOR */
  .add-mode-banner {
    position: fixed;
    top: 62px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--gold);
    color: var(--dark);
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1002;
    display: none;
    box-shadow: 0 4px 20px rgba(200,168,78,0.3);
    cursor: pointer;
  }
  .add-mode-banner.active { display: block; }

  /* STATS BAR */
  .stats-bar {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--dark-card);
    border: 1px solid var(--dark-border);
    border-radius: 10px;
    padding: 12px 16px;
    z-index: 1001;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    display: flex;
    gap: 20px;
  }
  .stat-item {
    text-align: center;
  }
  .stat-item .stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--gold);
  }
  .stat-item .stat-label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Tooltip styling */
  .leaflet-tooltip {
    background: var(--dark-card) !important;
    border: 1px solid var(--dark-border) !important;
    color: var(--text) !important;
    font-family: 'Inter', sans-serif !important;
    font-size: 11px !important;
    border-radius: 6px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
    padding: 4px 8px !important;
  }
  .leaflet-tooltip-top:before { border-top-color: var(--dark-border) !important; }
  .leaflet-tooltip-bottom:before { border-bottom-color: var(--dark-border) !important; }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    #header { padding: 0 12px; }
    #header .brand h1 span { display: none; }
    .legend-panel { bottom: 10px; left: 10px; padding: 10px 14px; min-width: 170px; }
    .stats-bar { bottom: 10px; right: 10px; padding: 8px 12px; gap: 12px; }
    .stat-item .stat-value { font-size: 14px; }
    .info-panel { right: 10px; min-width: 200px; }
    .filter-panel { width: 90%; }
    .add-mode-banner { width: 80%; text-align: center; }
  }
  @media (max-width: 480px) {
    .stats-bar { flex-wrap: wrap; gap: 8px; }
    .legend-panel { max-width: 160px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="brand">
    <div class="logo">R8</div>
    <h1>Rhino8 <span>Atlanta Westside Investment Map &mdash; Full Coverage</span></h1>
  </div>
  <div class="header-actions">
    <div class="search-wrapper">
      <input type="text" id="addressSearch" placeholder="Type address... (e.g. 1876 Madrona St NW Atlanta)" onkeydown="if(event.key==='Enter')searchAddress()" />
      <button class="search-btn" onclick="searchAddress()" title="Search address">&#x1F50D;</button>
      <div class="search-results" id="searchResults"></div>
    </div>
    <button class="header-btn" id="btnFilter" onclick="toggleFilter()">Filter</button>
    <button class="header-btn" id="btnExport" onclick="exportProperties()">Export CSV</button>
    <button class="header-btn gold" id="btnAddProperty" onclick="toggleAddMode()">+ Add Property</button>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- ADD MODE BANNER -->
<div class="add-mode-banner" id="addModeBanner" onclick="toggleAddMode()">
  Click anywhere on the map to drop a pin &mdash; Click here to cancel
</div>

<!-- FILTER PANEL -->
<div class="filter-panel" id="filterPanel">
  <label>Show properties:</label>
  <select id="arvFilter" onchange="applyFilter()">
    <option value="all">All Properties</option>
    <option value="green">Green (&le;50% ARV)</option>
    <option value="yellow">Yellow (50-65% ARV)</option>
    <option value="orange">Orange (65-70% ARV)</option>
    <option value="red">Red (&gt;70% ARV)</option>
    <option value="deals">Deals Only (&le;65% ARV)</option>
  </select>
  <button class="close-filter" onclick="toggleFilter()">&times;</button>
</div>

<!-- INFO PANEL (hover proximity) -->
<div class="info-panel" id="infoPanel">
  <div class="info-title">Investment Zone Score</div>
  <div class="info-row">
    <span class="info-label">Nearest Park</span>
    <span class="info-value" id="infoPark">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">Park Distance</span>
    <span class="info-value" id="infoParkDist">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">Beltline Distance</span>
    <span class="info-value" id="infoBeltDist">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">Nearest MARTA</span>
    <span class="info-value" id="infoMarta">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">MARTA Distance</span>
    <span class="info-value" id="infoMartaDist">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">Opportunity Zone</span>
    <span class="info-value" id="infoOZ">--</span>
  </div>
  <div class="info-row">
    <span class="info-label">Investment Zone</span>
    <span class="info-value" id="infoInZone">--</span>
  </div>
  <div class="score-bar"><div class="score-fill" id="scoreFill"></div></div>
  <div class="score-label" id="scoreLabel" style="color: var(--gold);">--</div>
</div>

<!-- LEGEND -->
<div class="legend-panel">
  <div class="legend-title">Legend</div>
  <div class="legend-item"><div class="legend-line" style="background:#00e676;"></div>BeltLine Trail (Built)</div>
  <div class="legend-item"><div class="legend-line-dashed" style="border-color:#00e676;"></div>BeltLine (Planned)</div>
  <div class="legend-item"><div class="legend-color" style="background:rgba(0,230,118,0.25); border:1px solid #00e676;"></div>Parks &amp; Green Space</div>
  <div class="legend-item"><div class="legend-ring" style="border-color:#00e676;"></div>0.25 mi (Premium)</div>
  <div class="legend-item"><div class="legend-ring" style="border-color:#ffd740;"></div>0.5 mi (Strong)</div>
  <div class="legend-item"><div class="legend-ring" style="border-color:#ff9100;"></div>1 mi (Good)</div>
  <div class="legend-item"><div class="legend-color" style="background:rgba(68,138,255,0.3); border:1px solid #448aff;"></div>Opportunity Zone</div>
  <div class="legend-item"><div class="legend-color" style="background:#448aff;"></div>Development</div>
  <div class="legend-item"><div class="legend-circle" style="background:#b388ff;"></div>MARTA Station</div>
  <div class="legend-item"><div class="legend-color" style="background:rgba(200,168,78,0.3); border:2px solid #c8a84e;"></div>Investment Zone</div>
  <div class="legend-item"><div class="legend-line-dashed" style="border-color:rgba(255,255,255,0.35);"></div>Interstate Highways</div>
  <div class="legend-item"><div class="legend-color" style="background:#c8a84e;"></div>My Properties</div>
  <div class="legend-title" style="margin-top:10px;">Property Pins</div>
  <div class="legend-item"><div class="legend-color" style="background:#00e676;"></div>&le;50% ARV (Great)</div>
  <div class="legend-item"><div class="legend-color" style="background:#ffd740;"></div>50-65% ARV (Good)</div>
  <div class="legend-item"><div class="legend-color" style="background:#ff9100;"></div>65-70% ARV (Fair)</div>
  <div class="legend-item"><div class="legend-color" style="background:#ff5252;"></div>&gt;70% ARV (Pass)</div>
</div>

<!-- STATS BAR -->
<div class="stats-bar" id="statsBar">
  <div class="stat-item">
    <div class="stat-value" id="statTotal">0</div>
    <div class="stat-label">Properties</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statDeals">0</div>
    <div class="stat-label">Deals (&le;65%)</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statAvgARV">--</div>
    <div class="stat-label">Avg % ARV</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statMonthlyRent">--</div>
    <div class="stat-label">Mo. Rent</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statAvgNOI">--</div>
    <div class="stat-label">Avg NOI</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statAnnualNOI">--</div>
    <div class="stat-label">Annual NOI</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statParks">19</div>
    <div class="stat-label">Parks</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statOZ">12</div>
    <div class="stat-label">OZ Tracts</div>
  </div>
  <div class="stat-item">
    <div class="stat-value" id="statMarta">8</div>
    <div class="stat-label">MARTA Stations</div>
  </div>
</div>

<script>
// ============================================
// CONFIGURATION & DATA
// ============================================

const MILES_TO_METERS = 1609.34;
const FEET_PER_MILE = 5280;

// ============================================
// RENTAL INCOME DATA — Section 8 & Market Rates
// ============================================

// 2025 HUD Fair Market Rents - Atlanta-Sandy Springs-Roswell MSA
const SECTION_8_FMR = {
  0: 1298,  // Studio
  1: 1412,  // 1BR
  2: 1589,  // 2BR
  3: 2048,  // 3BR
  4: 2399,  // 4BR
  5: 2759   // 5BR
};

// Small Area FMR by ZIP (Atlanta Housing uses SAFMRs)
// These are approximate - actual rates vary
const SAFMR_BY_ZIP = {
  '30310': { 0: 1150, 1: 1250, 2: 1400, 3: 1800, 4: 2100, 5: 2400 },
  '30311': { 0: 1100, 1: 1200, 2: 1350, 3: 1750, 4: 2050, 5: 2350 },
  '30314': { 0: 1100, 1: 1200, 2: 1350, 3: 1750, 4: 2050, 5: 2350 },
  '30318': { 0: 1200, 1: 1300, 2: 1500, 3: 1900, 4: 2250, 5: 2600 },
  '30331': { 0: 1150, 1: 1250, 2: 1400, 3: 1800, 4: 2100, 5: 2400 },
  '30344': { 0: 1100, 1: 1200, 2: 1350, 3: 1750, 4: 2050, 5: 2350 }
};

// Market rate estimates by bedroom (Westside Atlanta averages)
const MARKET_RENT = {
  1: 1100,
  2: 1400,
  3: 1800,
  4: 2100,
  5: 2500
};

// Rental expense defaults
const RENTAL_DEFAULTS = {
  vacancyMarket: 0.08,   // 8% vacancy for market rate
  vacancyS8: 0.03,       // 3% vacancy for Section 8
  management: 0.10,      // 10% property management
  insurance: 125,        // $125/mo insurance estimate
  taxes: 250,            // $250/mo property tax default (Fulton County avg)
  maintenance: 0.05      // 5% maintenance reserve
};

// ============================================
// PARKS DATA (Original 10 + 9 new = 19 total)
// ============================================
const PARKS = [
  // --- Original parks ---
  { name: "Westside Park", lat: 33.7720, lng: -84.4280, radius: 450, desc: "280 acres, largest park in Atlanta. Opened 2022. Former Bellwood Quarry." },
  { name: "Maddox Park", lat: 33.7580, lng: -84.4220, radius: 200, desc: "Historic Westside park with athletic fields and community center." },
  { name: "Washington Park", lat: 33.7480, lng: -84.4190, radius: 220, desc: "Historic park, one of Atlanta's oldest. Tennis, pool, playground." },
  { name: "Mozley Park", lat: 33.7530, lng: -84.4360, radius: 180, desc: "Community park with recreation center and athletic fields." },
  { name: "Vine City Park", lat: 33.7570, lng: -84.4060, radius: 120, desc: "Neighborhood park in Vine City. Close to Mercedes-Benz Stadium." },
  { name: "Enota Park", lat: 33.7660, lng: -84.4200, radius: 150, desc: "Community park near Grove Park neighborhood." },
  { name: "Anderson Park", lat: 33.7740, lng: -84.4150, radius: 120, desc: "Neighborhood park in the Bankhead area." },
  { name: "Lindsay Street Park", lat: 33.7610, lng: -84.4100, radius: 80, desc: "Pocket park in English Avenue neighborhood." },
  { name: "Cook Park", lat: 33.7540, lng: -84.4130, radius: 100, desc: "Neighborhood park near AUC." },
  { name: "Rose Circle Park", lat: 33.7580, lng: -84.4310, radius: 90, desc: "Small park in the Dixie Hills neighborhood." },
  // --- New parks (Southside / Southwest expansion) ---
  { name: "Cascade Springs Nature Preserve", lat: 33.7230, lng: -84.4710, radius: 320, desc: "120-acre nature preserve with waterfalls, trails, and bamboo forest. Hidden gem of SW Atlanta." },
  { name: "Adams Park", lat: 33.7130, lng: -84.4850, radius: 200, desc: "Community recreation center and park in Adamsville area. Athletic fields and playground." },
  { name: "Greenbriar Park", lat: 33.7050, lng: -84.4680, radius: 180, desc: "Neighborhood park near Greenbriar Mall in Southwest Atlanta." },
  { name: "Perkerson Park", lat: 33.7120, lng: -84.4120, radius: 220, desc: "Large community park with walking trails, athletic fields, and splash pad. Capitol View area." },
  { name: "Pittsburgh Yards", lat: 33.7320, lng: -84.4050, radius: 140, desc: "Mixed-use development and community space in historic Pittsburgh neighborhood. Innovation hub." },
  { name: "Capitol View Park", lat: 33.7200, lng: -84.4150, radius: 130, desc: "Neighborhood park serving the Capitol View and Capitol View Manor communities." },
  { name: "Lionel Hampton Trail", lat: 33.7280, lng: -84.3990, radius: 100, desc: "BeltLine-connected trail corridor. Key connector for Southside neighborhoods." },
  { name: "Oakland City Park", lat: 33.7220, lng: -84.4260, radius: 160, desc: "Community park near Oakland City MARTA station. Athletic fields and recreation." },
  { name: "Outdoor Activity Center", lat: 33.7150, lng: -84.4240, radius: 250, desc: "135-acre urban nature preserve operated by Georgia Audubon. Trails, wetlands, wildlife." },
  // --- Additional parks / green spaces ---
  { name: "Mason Turner Park (Under Construction)", lat: 33.7630, lng: -84.4130, radius: 160, desc: "New park under construction off Mason Turner Rd NW. Part of Westside revitalization and green infrastructure investment." },
  { name: "Rodney Cook Sr. Park", lat: 33.7565, lng: -84.4045, radius: 140, desc: "18-acre park in Vine City. Stormwater management + monument to civil rights leaders. Opened 2021." }
];

// ============================================
// MARTA STATIONS
// ============================================
const MARTA_STATIONS = [
  { name: "Five Points Station", lat: 33.7540, lng: -84.3916, lines: "Red/Gold/Blue/Green", desc: "Central hub. All 4 rail lines converge here. Highest ridership in system." },
  { name: "West End Station", lat: 33.7365, lng: -84.4128, lines: "Red/Gold", desc: "Southside station. TOD area with active redevelopment. BeltLine adjacent." },
  { name: "Oakland City Station", lat: 33.7172, lng: -84.4252, lines: "Red/Gold", desc: "Southside station serving Oakland City, Sylvan Hills. TOD opportunity." },
  { name: "Lakewood/Ft McPherson Station", lat: 33.7003, lng: -84.4293, lines: "Red/Gold", desc: "Southside station near Tyler Perry Studios and Fort McPherson redevelopment." },
  { name: "Bankhead Station", lat: 33.7724, lng: -84.4286, lines: "Green", desc: "Westside station serving Bankhead, Grove Park. BeltLine Westside Trail connection." },
  { name: "Vine City Station", lat: 33.7565, lng: -84.4043, lines: "Blue/Green", desc: "Near Mercedes-Benz Stadium, State Farm Arena. Major event transit hub." },
  { name: "Ashby Station", lat: 33.7529, lng: -84.4170, lines: "Blue/Green", desc: "Serving AUC (Morehouse, Spelman, Clark Atlanta). West End connector." },
  { name: "Hamilton E. Holmes Station", lat: 33.7547, lng: -84.4697, lines: "Blue/Green", desc: "Western terminus. Park-and-ride. Serves Adamsville, Collier Heights." }
];

// ============================================
// BELTLINE TRAIL COORDINATES
// ============================================

// Westside BeltLine trail (existing — original coords)
const BELTLINE_WESTSIDE_COORDS = [
  [33.7830, -84.4220],
  [33.7810, -84.4210],
  [33.7790, -84.4195],
  [33.7770, -84.4185],
  [33.7750, -84.4175],
  [33.7730, -84.4168],
  [33.7710, -84.4160],
  [33.7695, -84.4148],
  [33.7680, -84.4135],
  [33.7665, -84.4120],
  [33.7650, -84.4108],
  [33.7635, -84.4095],
  [33.7620, -84.4082],
  [33.7605, -84.4070],
  [33.7590, -84.4060],
  [33.7575, -84.4050],
  [33.7560, -84.4042],
  [33.7545, -84.4035],
  [33.7530, -84.4028],
  [33.7510, -84.4020],
  [33.7490, -84.4015],
  [33.7470, -84.4010],
  [33.7450, -84.4005],
  [33.7435, -84.4000]
];

// Planned Westside extension north (dashed)
const BELTLINE_WESTSIDE_PLANNED = [
  [33.7830, -84.4220],
  [33.7850, -84.4230],
  [33.7870, -84.4245],
  [33.7890, -84.4255],
  [33.7910, -84.4270]
];

// Southside BeltLine trail — completed sections (approximate)
const BELTLINE_SOUTHSIDE_BUILT = [
  [33.7435, -84.4000],
  [33.7410, -84.3995],
  [33.7385, -84.3990],
  [33.7365, -84.3988],
  [33.7345, -84.3990],
  [33.7325, -84.3995],
  [33.7305, -84.4000],
  [33.7285, -84.4010],
  [33.7270, -84.4020]
];

// Southside BeltLine trail — planned sections (approximate path through Pittsburgh, Capitol View)
const BELTLINE_SOUTHSIDE_PLANNED = [
  [33.7270, -84.4020],
  [33.7250, -84.4035],
  [33.7230, -84.4050],
  [33.7210, -84.4068],
  [33.7190, -84.4085],
  [33.7170, -84.4100],
  [33.7150, -84.4115],
  [33.7130, -84.4130],
  [33.7110, -84.4148],
  [33.7090, -84.4165],
  [33.7070, -84.4180],
  [33.7050, -84.4195]
];

// Proctor Creek Greenway — Westside Reservoir Park to Maddox Park via Hollowell
const PROCTOR_CREEK_GREENWAY = [
  [33.7750, -84.4290],  // Westside Reservoir Park (south end)
  [33.7730, -84.4270],
  [33.7710, -84.4250],  // Along Proctor Creek
  [33.7690, -84.4240],
  [33.7670, -84.4230],  // Crossing near Hollowell Pkwy
  [33.7650, -84.4225],
  [33.7630, -84.4220],
  [33.7610, -84.4218],
  [33.7590, -84.4220],  // Approaching Maddox Park
  [33.7580, -84.4220]   // Maddox Park
];

// Combined all beltline/greenway coords for proximity calc
const ALL_BELTLINE_COORDS = [
  ...BELTLINE_WESTSIDE_COORDS,
  ...BELTLINE_SOUTHSIDE_BUILT,
  ...BELTLINE_SOUTHSIDE_PLANNED,
  ...PROCTOR_CREEK_GREENWAY
];

// ============================================
// OPPORTUNITY ZONES (Original 6 + 6 new = 12)
// ============================================
const OZ_ZONES = [
  // --- Original zones ---
  {
    name: "English Avenue / Vine City",
    tract: "13121-0039",
    coords: [
      [33.7630, -84.4120], [33.7630, -84.3980], [33.7530, -84.3980],
      [33.7530, -84.4120], [33.7630, -84.4120]
    ]
  },
  {
    name: "Bankhead / Grove Park",
    tract: "13121-0087",
    coords: [
      [33.7820, -84.4350], [33.7820, -84.4140], [33.7700, -84.4140],
      [33.7700, -84.4350], [33.7820, -84.4350]
    ]
  },
  {
    name: "Ashview Heights / AUC",
    tract: "13121-0041",
    coords: [
      [33.7600, -84.4250], [33.7600, -84.4100], [33.7480, -84.4100],
      [33.7480, -84.4250], [33.7600, -84.4250]
    ]
  },
  {
    name: "Carey Park / Hunter Hills",
    tract: "13121-0044",
    coords: [
      [33.7530, -84.4360], [33.7530, -84.4250], [33.7440, -84.4250],
      [33.7440, -84.4360], [33.7530, -84.4360]
    ]
  },
  {
    name: "English Avenue North",
    tract: "13121-0038",
    coords: [
      [33.7700, -84.4140], [33.7700, -84.4020], [33.7630, -84.4020],
      [33.7630, -84.4140], [33.7700, -84.4140]
    ]
  },
  {
    name: "Dixie Hills",
    tract: "13121-0050",
    coords: [
      [33.7650, -84.4400], [33.7650, -84.4250], [33.7560, -84.4250],
      [33.7560, -84.4400], [33.7650, -84.4400]
    ]
  },
  // --- New Southside/Southwest OZ tracts ---
  {
    name: "Capitol View / Capitol View Manor",
    tract: "13121-0068",
    coords: [
      [33.7280, -84.4220], [33.7280, -84.4070], [33.7150, -84.4070],
      [33.7150, -84.4220], [33.7280, -84.4220]
    ]
  },
  {
    name: "Pittsburgh / Mechanicsville",
    tract: "13121-0046",
    coords: [
      [33.7440, -84.4100], [33.7440, -84.3940], [33.7320, -84.3940],
      [33.7320, -84.4100], [33.7440, -84.4100]
    ]
  },
  {
    name: "Sylvan Hills / Oakland City",
    tract: "13121-0072",
    coords: [
      [33.7320, -84.4380], [33.7320, -84.4200], [33.7150, -84.4200],
      [33.7150, -84.4380], [33.7320, -84.4380]
    ]
  },
  {
    name: "Lakewood Heights",
    tract: "13121-0076",
    coords: [
      [33.7150, -84.4070], [33.7150, -84.3900], [33.7020, -84.3900],
      [33.7020, -84.4070], [33.7150, -84.4070]
    ]
  },
  {
    name: "Adair Park / West End",
    tract: "13121-0057",
    coords: [
      [33.7440, -84.4250], [33.7440, -84.4100], [33.7320, -84.4100],
      [33.7320, -84.4250], [33.7440, -84.4250]
    ]
  },
  {
    name: "Westview / Cascade Heights Entry",
    tract: "13121-0060",
    coords: [
      [33.7440, -84.4470], [33.7440, -84.4250], [33.7320, -84.4250],
      [33.7320, -84.4470], [33.7440, -84.4470]
    ]
  }
];

// ============================================
// DEVELOPMENTS (Original 8 + 6 new = 14)
// ============================================
const DEVELOPMENTS = [
  // --- Original ---
  {
    name: "Microsoft Data Center Campus",
    lat: 33.7735, lng: -84.4260,
    desc: "Massive data center campus adjacent to Westside Park. Multi-billion dollar investment bringing jobs and infrastructure to the Westside.",
    status: "Under Development"
  },
  {
    name: "Westside Park Phase 2 Expansion",
    lat: 33.7740, lng: -84.4310,
    desc: "Additional trails, amenities, and parkland expansion. Connecting to the BeltLine Westside Trail.",
    status: "Planned"
  },
  {
    name: "BeltLine Westside Trail Extension",
    lat: 33.7870, lng: -84.4245,
    desc: "Northward extension of the Westside Trail toward Bankhead MARTA station. Will complete the full loop.",
    status: "Planned"
  },
  {
    name: "Mercedes-Benz Stadium District",
    lat: 33.7553, lng: -84.4006,
    desc: "Continued mixed-use development around the stadium. Hotels, retail, residential in the Vine City area.",
    status: "Ongoing"
  },
  {
    name: "The Gulch Redevelopment (CIM Group)",
    lat: 33.7510, lng: -84.3940,
    desc: "Massive $5B+ mixed-use development. 40 acres downtown near Westside. Office, residential, retail, entertainment.",
    status: "Approved / Early Phase"
  },
  {
    name: "Rodney Cook Sr. Park",
    lat: 33.7585, lng: -84.4035,
    desc: "Completed stormwater park and memorial in Vine City. Major green infrastructure investment.",
    status: "Complete"
  },
  {
    name: "Westside Future Fund Revitalization",
    lat: 33.7610, lng: -84.4090,
    desc: "Anti-displacement program. New affordable housing, homeownership, and community investment in English Avenue and Vine City.",
    status: "Ongoing"
  },
  {
    name: "Proctor Creek Greenway",
    lat: 33.7780, lng: -84.4300,
    desc: "Multi-mile greenway trail and stormwater infrastructure along Proctor Creek. Connects neighborhoods to Westside Park.",
    status: "Under Development"
  },
  // --- New Southside/Southwest developments ---
  {
    name: "Tyler Perry Studios (Fort McPherson)",
    lat: 33.7100, lng: -84.4350,
    desc: "330-acre film studio complex on former Fort McPherson. Largest production studio in the US. Major economic engine for SW Atlanta.",
    status: "Complete"
  },
  {
    name: "Oakland City MARTA TOD",
    lat: 33.7172, lng: -84.4255,
    desc: "Transit-Oriented Development around Oakland City MARTA station. Mixed-use residential, retail, community space. Walking distance to BeltLine.",
    status: "Planned"
  },
  {
    name: "West End MARTA Station Redevelopment",
    lat: 33.7368, lng: -84.4130,
    desc: "Mixed-use TOD adjacent to West End station. Residential, retail, office. BeltLine Southside Trail adjacent. Key catalytic project.",
    status: "Under Development"
  },
  {
    name: "Greenbriar Mall Redevelopment",
    lat: 33.7065, lng: -84.4695,
    desc: "Plans for major redevelopment of the historic Greenbriar Mall into mixed-use destination. Residential, retail, entertainment, community space.",
    status: "Planned"
  },
  {
    name: "Fort McPherson Mixed-Use Redevelopment",
    lat: 33.7060, lng: -84.4310,
    desc: "Beyond Tyler Perry Studios, the broader Fort McPherson site includes plans for housing, retail, parks, and innovation space. ~145 acres available.",
    status: "Planned"
  },
  {
    name: "Lee + White / BeltLine Westside Connector",
    lat: 33.7380, lng: -84.4065,
    desc: "Adaptive reuse food hall and mixed-use corridor along the BeltLine. Breweries, restaurants, retail. Model for Southside development.",
    status: "Complete"
  }
];

// ============================================
// JAMAAL'S PROPERTIES
// ============================================
const MY_PROPERTIES = [
  {
    name: "1876 Madrona St NW",
    lat: 33.7720, lng: -84.4180,
    desc: "4br/2ba | $176K purchase | $335K ARV | $48.9K rehab | Dark Modern Ranch design. Seller: Juan Blackwell.",
    status: "Under Contract"
  },
  {
    name: "1255 North Ave NW",
    lat: 33.7670, lng: -84.4050,
    desc: "OWNED. First completed project. 4br rental — nanny occupying.",
    status: "Completed"
  }
];

// ============================================
// INTERSTATE HIGHWAYS (approximate polyline coords)
// ============================================

// I-75/I-85 Downtown Connector running south from Midtown through Downtown
const I75_I85_CONNECTOR = [
  [33.7900, -84.3870],
  [33.7860, -84.3875],
  [33.7820, -84.3880],
  [33.7780, -84.3882],
  [33.7740, -84.3885],
  [33.7700, -84.3888],
  [33.7660, -84.3890],
  [33.7620, -84.3892],
  [33.7580, -84.3895],
  [33.7540, -84.3900],
  [33.7500, -84.3910],
  [33.7460, -84.3920],
  [33.7420, -84.3930],
  [33.7380, -84.3940],
  [33.7340, -84.3948],
  [33.7300, -84.3955],
  [33.7260, -84.3960],
  [33.7220, -84.3968]
];

// I-20 heading west from Downtown
const I20_WEST = [
  [33.7510, -84.3920],
  [33.7490, -84.3970],
  [33.7470, -84.4020],
  [33.7445, -84.4080],
  [33.7425, -84.4140],
  [33.7405, -84.4200],
  [33.7385, -84.4260],
  [33.7365, -84.4320],
  [33.7345, -84.4380],
  [33.7325, -84.4440],
  [33.7305, -84.4500],
  [33.7290, -84.4560],
  [33.7275, -84.4620],
  [33.7260, -84.4680],
  [33.7245, -84.4740],
  [33.7230, -84.4810],
  [33.7210, -84.4880],
  [33.7195, -84.4940],
  [33.7180, -84.5010],
  [33.7165, -84.5080]
];

// I-75 heading northwest from Downtown toward I-285
const I75_NORTHWEST = [
  [33.7580, -84.3895],
  [33.7620, -84.3940],
  [33.7660, -84.3980],
  [33.7700, -84.4010],
  [33.7740, -84.4030],
  [33.7780, -84.4060],
  [33.7820, -84.4100],
  [33.7860, -84.4140],
  [33.7900, -84.4175],
  [33.7950, -84.4210],
  [33.8000, -84.4250],
  [33.8050, -84.4290],
  [33.8100, -84.4330],
  [33.8150, -84.4370],
  [33.8200, -84.4410],
  [33.8250, -84.4450],
  [33.8300, -84.4490]
];

// I-285 south/west loop (from south where I-75 meets it, arcing west and north)
const I285_LOOP = [
  [33.6880, -84.3900],
  [33.6870, -84.3980],
  [33.6865, -84.4060],
  [33.6862, -84.4140],
  [33.6860, -84.4220],
  [33.6865, -84.4300],
  [33.6870, -84.4380],
  [33.6880, -84.4460],
  [33.6895, -84.4540],
  [33.6910, -84.4620],
  [33.6935, -84.4700],
  [33.6960, -84.4770],
  [33.6990, -84.4840],
  [33.7025, -84.4910],
  [33.7060, -84.4970],
  [33.7100, -84.5020],
  [33.7145, -84.5060],
  [33.7195, -84.5090],
  [33.7245, -84.5110],
  [33.7300, -84.5120],
  [33.7360, -84.5125],
  [33.7420, -84.5120],
  [33.7480, -84.5110],
  [33.7540, -84.5095],
  [33.7600, -84.5070],
  [33.7660, -84.5040],
  [33.7720, -84.5000],
  [33.7780, -84.4960],
  [33.7840, -84.4910],
  [33.7900, -84.4860],
  [33.7950, -84.4800],
  [33.8000, -84.4740],
  [33.8050, -84.4680],
  [33.8100, -84.4620],
  [33.8150, -84.4560],
  [33.8200, -84.4510],
  [33.8250, -84.4470],
  [33.8300, -84.4440]
];

// ============================================
// INVESTMENT ZONE BOUNDARY (Half-Moon / Crescent)
// Covers Atlanta's Westside inside city limits
// East: Downtown Connector (I-85/I-75)
// South: I-20 west then I-285 south
// West: I-285 west loop north
// North: I-75 NW to I-285
// ============================================
const INVESTMENT_ZONE = [
  // Start at Downtown (I-75/I-85/I-20 interchange area)
  [33.7540, -84.3900],
  // East edge: follow Downtown Connector south
  [33.7500, -84.3910],
  [33.7460, -84.3920],
  [33.7420, -84.3930],
  [33.7380, -84.3940],
  [33.7340, -84.3948],
  [33.7300, -84.3955],
  [33.7260, -84.3960],
  [33.7220, -84.3968],
  // South: cut west along I-20 corridor and city limits
  [33.7180, -84.3970],
  [33.7140, -84.3975],
  [33.7100, -84.3980],
  [33.7050, -84.3990],
  [33.7000, -84.4000],
  // Southeast corner near Lakewood / city limit
  [33.6960, -84.4050],
  [33.6940, -84.4120],
  [33.6930, -84.4200],
  // Follow city limit south/southwest (staying inside Atlanta)
  [33.6920, -84.4300],
  [33.6920, -84.4400],
  [33.6930, -84.4500],
  [33.6945, -84.4600],
  [33.6960, -84.4700],
  // Southwest corner — near East Point border, staying inside ATL
  [33.6980, -84.4800],
  [33.7010, -84.4880],
  [33.7050, -84.4940],
  [33.7100, -84.4980],
  // West edge — follow city limit / I-285 corridor north
  [33.7160, -84.5010],
  [33.7220, -84.5020],
  [33.7280, -84.5020],
  [33.7340, -84.5010],
  [33.7400, -84.4990],
  [33.7460, -84.4970],
  [33.7520, -84.4940],
  [33.7580, -84.4900],
  [33.7640, -84.4860],
  [33.7700, -84.4810],
  [33.7760, -84.4760],
  [33.7820, -84.4700],
  // Northwest — heading toward I-75/I-285 interchange
  [33.7880, -84.4640],
  [33.7940, -84.4570],
  [33.8000, -84.4500],
  [33.8050, -84.4440],
  // North edge — follow I-75 back southeast toward downtown
  [33.8020, -84.4380],
  [33.7970, -84.4320],
  [33.7920, -84.4260],
  [33.7870, -84.4200],
  [33.7820, -84.4150],
  [33.7780, -84.4100],
  [33.7740, -84.4050],
  [33.7700, -84.4010],
  [33.7660, -84.3980],
  [33.7620, -84.3950],
  [33.7580, -84.3920],
  // Close back to start
  [33.7540, -84.3900]
];


// ============================================
// MAP INITIALIZATION
// ============================================

const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
  subdomains: 'abcd',
  maxZoom: 19
});

// Center on the half-moon area — slightly south/west of the original center
const map = L.map('map', {
  center: [33.7350, -84.4400],
  zoom: 12,
  layers: [darkTiles],
  zoomControl: true
});

map.zoomControl.setPosition('bottomright');


// ============================================
// LAYER GROUPS
// ============================================

const investmentZoneLayer = L.layerGroup();
const interstateLayer = L.layerGroup();
const beltlineLayer = L.layerGroup();
const parksLayer = L.layerGroup();
const ringsLayer = L.layerGroup();
const ozLayer = L.layerGroup();
const developmentLayer = L.layerGroup();
const martaLayer = L.layerGroup();
const myPropertiesLayer = L.layerGroup();
const propertyPinsLayer = L.layerGroup();


// ============================================
// 0. INVESTMENT ZONE BOUNDARY
// ============================================

// Gold outline polygon — semi-transparent fill
L.polygon(INVESTMENT_ZONE, {
  color: '#c8a84e',
  fillColor: '#c8a84e',
  fillOpacity: 0.06,
  weight: 3,
  opacity: 0.7,
  dashArray: '12, 6'
}).bindTooltip('Rhino8 Investment Zone', { sticky: true }).addTo(investmentZoneLayer);

// Glow effect
L.polygon(INVESTMENT_ZONE, {
  color: '#c8a84e',
  fillColor: 'transparent',
  fillOpacity: 0,
  weight: 8,
  opacity: 0.15
}).addTo(investmentZoneLayer);

investmentZoneLayer.addTo(map);


// ============================================
// 0b. INTERSTATE HIGHWAYS
// ============================================

const interstateStyle = {
  color: 'rgba(255,255,255,0.35)',
  weight: 2,
  opacity: 0.6,
  dashArray: '8, 6',
  lineJoin: 'round',
  lineCap: 'round'
};

const interstateGlowStyle = {
  color: 'rgba(255,255,255,0.08)',
  weight: 8,
  opacity: 0.3,
  lineJoin: 'round',
  lineCap: 'round'
};

// I-75/I-85 Downtown Connector
L.polyline(I75_I85_CONNECTOR, interstateGlowStyle).addTo(interstateLayer);
L.polyline(I75_I85_CONNECTOR, interstateStyle).bindTooltip('I-75 / I-85 (Downtown Connector)', { sticky: true }).addTo(interstateLayer);

// I-20 West
L.polyline(I20_WEST, interstateGlowStyle).addTo(interstateLayer);
L.polyline(I20_WEST, interstateStyle).bindTooltip('I-20 West', { sticky: true }).addTo(interstateLayer);

// I-75 Northwest
L.polyline(I75_NORTHWEST, interstateGlowStyle).addTo(interstateLayer);
L.polyline(I75_NORTHWEST, interstateStyle).bindTooltip('I-75 Northwest', { sticky: true }).addTo(interstateLayer);

// I-285 Loop
L.polyline(I285_LOOP, interstateGlowStyle).addTo(interstateLayer);
L.polyline(I285_LOOP, interstateStyle).bindTooltip('I-285 Perimeter', { sticky: true }).addTo(interstateLayer);

interstateLayer.addTo(map);


// ============================================
// 1. BELTLINE TRAILS
// ============================================

// Westside Trail — bright green (built)
L.polyline(BELTLINE_WESTSIDE_COORDS, {
  color: '#00e676',
  weight: 5,
  opacity: 0.9,
  lineJoin: 'round',
  lineCap: 'round'
}).bindTooltip('Westside BeltLine Trail (Built)', { sticky: true }).addTo(beltlineLayer);

// Westside glow
L.polyline(BELTLINE_WESTSIDE_COORDS, {
  color: '#00e676',
  weight: 12,
  opacity: 0.15,
  lineJoin: 'round',
  lineCap: 'round'
}).addTo(beltlineLayer);

// Planned Westside extension — dashed
L.polyline(BELTLINE_WESTSIDE_PLANNED, {
  color: '#00e676',
  weight: 4,
  opacity: 0.5,
  dashArray: '10, 10',
  lineJoin: 'round',
  lineCap: 'round'
}).bindTooltip('Planned Westside Extension', { sticky: true }).addTo(beltlineLayer);

// Southside Trail — built sections
L.polyline(BELTLINE_SOUTHSIDE_BUILT, {
  color: '#00e676',
  weight: 5,
  opacity: 0.9,
  lineJoin: 'round',
  lineCap: 'round'
}).bindTooltip('Southside BeltLine Trail (Built)', { sticky: true }).addTo(beltlineLayer);

// Southside glow
L.polyline(BELTLINE_SOUTHSIDE_BUILT, {
  color: '#00e676',
  weight: 12,
  opacity: 0.15,
  lineJoin: 'round',
  lineCap: 'round'
}).addTo(beltlineLayer);

// Southside Trail — planned sections (dashed)
L.polyline(BELTLINE_SOUTHSIDE_PLANNED, {
  color: '#00e676',
  weight: 4,
  opacity: 0.5,
  dashArray: '10, 10',
  lineJoin: 'round',
  lineCap: 'round'
}).bindTooltip('Planned Southside Trail Extension', { sticky: true }).addTo(beltlineLayer);

// Proctor Creek Greenway — Westside Reservoir Park to Maddox Park
L.polyline(PROCTOR_CREEK_GREENWAY, {
  color: '#4caf50',
  weight: 5,
  opacity: 0.7,
  dashArray: '8, 6',
  lineJoin: 'round',
  lineCap: 'round'
}).bindTooltip('Proctor Creek Greenway (Westside Reservoir → Maddox Park)', { sticky: true }).addTo(beltlineLayer);

beltlineLayer.addTo(map);


// ============================================
// 2. PARKS & GREEN SPACES
// ============================================

PARKS.forEach(park => {
  L.circle([park.lat, park.lng], {
    radius: park.radius,
    color: '#00e676',
    fillColor: '#00e676',
    fillOpacity: 0.15,
    weight: 2,
    opacity: 0.6
  }).bindPopup(`
    <div class="popup-title">${park.name}</div>
    <div class="popup-subtitle">${park.desc}</div>
  `).bindTooltip(park.name).addTo(parksLayer);

  L.marker([park.lat, park.lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="
        background: rgba(0,230,118,0.2);
        border: 1px solid #00e676;
        border-radius: 50%;
        width: 12px;
        height: 12px;
      "></div>`,
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    })
  }).addTo(parksLayer);
});

parksLayer.addTo(map);


// ============================================
// 3. PROXIMITY RINGS
// ============================================

function addRings(lat, lng, name) {
  // 0.25 mile
  L.circle([lat, lng], {
    radius: 0.25 * MILES_TO_METERS,
    color: '#00e676',
    fillColor: '#00e676',
    fillOpacity: 0.03,
    weight: 1.5,
    opacity: 0.35,
    dashArray: '6, 4'
  }).bindTooltip(`${name} -- 0.25 mi`).addTo(ringsLayer);

  // 0.5 mile
  L.circle([lat, lng], {
    radius: 0.5 * MILES_TO_METERS,
    color: '#ffd740',
    fillColor: '#ffd740',
    fillOpacity: 0.02,
    weight: 1.5,
    opacity: 0.3,
    dashArray: '6, 4'
  }).bindTooltip(`${name} -- 0.5 mi`).addTo(ringsLayer);

  // 1 mile
  L.circle([lat, lng], {
    radius: 1.0 * MILES_TO_METERS,
    color: '#ff9100',
    fillColor: '#ff9100',
    fillOpacity: 0.01,
    weight: 1,
    opacity: 0.2,
    dashArray: '8, 6'
  }).bindTooltip(`${name} -- 1 mi`).addTo(ringsLayer);
}

// Rings from parks
PARKS.forEach(p => addRings(p.lat, p.lng, p.name));

// Rings from Beltline trail points (every 5th point)
for (let i = 0; i < BELTLINE_WESTSIDE_COORDS.length; i += 5) {
  addRings(BELTLINE_WESTSIDE_COORDS[i][0], BELTLINE_WESTSIDE_COORDS[i][1], 'BeltLine');
}

// Rings OFF by default (too many circles)


// ============================================
// 4. OPPORTUNITY ZONES
// ============================================

OZ_ZONES.forEach(oz => {
  L.polygon(oz.coords, {
    color: '#448aff',
    fillColor: '#448aff',
    fillOpacity: 0.12,
    weight: 2,
    opacity: 0.5,
    dashArray: '4, 4'
  }).bindPopup(`
    <div class="popup-title">Opportunity Zone</div>
    <div class="popup-subtitle">${oz.name}</div>
    <div class="popup-row">
      <span class="popup-label">Census Tract</span>
      <span class="popup-value">${oz.tract}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">Tax Benefit</span>
      <span class="popup-value" style="color:#00e676;">Capital Gains Deferral</span>
    </div>
  `).bindTooltip(`OZ: ${oz.name}`).addTo(ozLayer);
});

ozLayer.addTo(map);


// ============================================
// 5. KNOWN DEVELOPMENTS
// ============================================

DEVELOPMENTS.forEach(dev => {
  const statusColor = dev.status === 'Complete' ? '#00e676' :
                      dev.status === 'Ongoing' ? '#ffd740' :
                      dev.status === 'Under Development' ? '#ff9100' : '#448aff';

  L.marker([dev.lat, dev.lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="
        background: ${statusColor};
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 10px ${statusColor}44;
        display: flex;
        align-items: center;
        justify-content: center;
      "><div style="width:6px;height:6px;background:white;border-radius:1px;"></div></div>`,
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    })
  }).bindPopup(`
    <div class="popup-title">${dev.name}</div>
    <div class="popup-subtitle">${dev.desc}</div>
    <div class="popup-row">
      <span class="popup-label">Status</span>
      <span class="popup-value" style="color:${statusColor};">${dev.status}</span>
    </div>
  `).bindTooltip(dev.name).addTo(developmentLayer);
});

developmentLayer.addTo(map);


// ============================================
// 6. MARTA STATIONS
// ============================================

MARTA_STATIONS.forEach(station => {
  L.marker([station.lat, station.lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="
        position: relative;
        width: 22px;
        height: 22px;
      ">
        <div style="
          position: absolute;
          top: 0; left: 0;
          width: 22px;
          height: 22px;
          background: #b388ff;
          border-radius: 50%;
          border: 2px solid rgba(255,255,255,0.4);
          box-shadow: 0 0 12px rgba(179,136,255,0.4);
          display: flex;
          align-items: center;
          justify-content: center;
        "><div style="
          font-size: 9px;
          font-weight: 800;
          color: #0a0a0a;
          line-height: 1;
        ">M</div></div>
      </div>`,
      iconSize: [22, 22],
      iconAnchor: [11, 11],
      popupAnchor: [0, -11]
    })
  }).bindPopup(`
    <div class="popup-title">${station.name}</div>
    <div class="popup-subtitle">${station.desc}</div>
    <div class="popup-row">
      <span class="popup-label">Lines</span>
      <span class="popup-value" style="color:#b388ff;">${station.lines}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">Value Driver</span>
      <span class="popup-value" style="color:#00e676;">High (Transit Proximity)</span>
    </div>
  `).bindTooltip(station.name).addTo(martaLayer);
});

martaLayer.addTo(map);


// ============================================
// 7. MY PROPERTIES (Jamaal's)
// ============================================

MY_PROPERTIES.forEach(prop => {
  const statusColor = prop.status === 'Closing' ? '#ffd740' : '#ff9100';

  L.marker([prop.lat, prop.lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="
        position: relative;
        width: 28px;
        height: 28px;
      ">
        <div style="
          position: absolute;
          top: 0; left: 0;
          width: 28px;
          height: 28px;
          background: #c8a84e;
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          border: 2px solid #e0c872;
          box-shadow: 0 0 16px rgba(200,168,78,0.4);
        "></div>
        <div style="
          position: absolute;
          top: 3px; left: 3px;
          width: 22px;
          height: 22px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: 800;
          color: #0a0a0a;
          z-index: 1;
        ">R8</div>
      </div>`,
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      popupAnchor: [0, -28]
    })
  }).bindPopup(`
    <div class="popup-title" style="font-size:15px;">${prop.name}</div>
    <div class="popup-subtitle">${prop.desc}</div>
    <div class="popup-row">
      <span class="popup-label">Status</span>
      <span class="popup-value" style="color:${statusColor};">${prop.status}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">Owner</span>
      <span class="popup-value" style="color:var(--gold);">Jamaal Richard</span>
    </div>
  `).bindTooltip(prop.name).addTo(myPropertiesLayer);
});

myPropertiesLayer.addTo(map);


// ============================================
// 8. PROPERTY PINS (User-added, localStorage)
// ============================================

let properties = JSON.parse(localStorage.getItem('r8_properties') || '[]');
let addMode = false;
let tempMarker = null;

function saveProperties() {
  localStorage.setItem('r8_properties', JSON.stringify(properties));
  updateStats();
}

function getARVColor(pct) {
  if (pct <= 50) return '#00e676';
  if (pct <= 65) return '#ffd740';
  if (pct <= 70) return '#ff9100';
  return '#ff5252';
}

function getARVLabel(pct) {
  if (pct <= 50) return 'Great Deal';
  if (pct <= 65) return 'Good Deal';
  if (pct <= 70) return 'Fair';
  return 'Pass';
}

function createPropertyMarker(prop, index) {
  const color = getARVColor(prop.arvPct);

  const marker = L.marker([prop.lat, prop.lng], {
    icon: L.divIcon({
      className: '',
      html: `<div style="
        position: relative;
        width: 24px;
        height: 24px;
      ">
        <div style="
          position: absolute;
          top: 0; left: 0;
          width: 24px;
          height: 24px;
          background: ${color};
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          border: 2px solid rgba(255,255,255,0.3);
          box-shadow: 0 0 12px ${color}44;
        "></div>
        <div style="
          position: absolute;
          top: 2px; left: 2px;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 9px;
          font-weight: 800;
          color: #0a0a0a;
          z-index: 1;
        ">${Math.round(prop.arvPct)}%</div>
      </div>`,
      iconSize: [24, 24],
      iconAnchor: [12, 24],
      popupAnchor: [0, -24]
    }),
    propertyIndex: index,
    arvPct: prop.arvPct
  });

  const fmtPrice = prop.price ? '$' + Number(prop.price).toLocaleString() : '--';
  const fmtARV = prop.arv ? '$' + Number(prop.arv).toLocaleString() : '--';
  const fmtRehab = prop.rehab ? '$' + Number(prop.rehab).toLocaleString() : '--';
  const spread = (prop.arv && prop.price && prop.rehab) ? '$' + (prop.arv - prop.price - prop.rehab).toLocaleString() : '--';

  // Rental data for popup
  const hasRental = prop.beds && prop.beds > 0;
  const noiColor = (prop.monthlyNOI || 0) >= 0 ? '#c8a84e' : '#ff5252';
  const rentTypeLabel = prop.rentType === 's8' ? 'Section 8' : prop.rentType === 'both' ? 'Market / S8' : 'Market';
  const activeRentFmt = prop.activeRent ? '$' + Number(prop.activeRent).toLocaleString() : '--';
  const noiFmt = prop.monthlyNOI !== undefined && prop.monthlyNOI !== null ? '$' + Math.round(prop.monthlyNOI).toLocaleString() : '--';
  const capFmt = prop.capRate !== undefined && prop.capRate !== null ? prop.capRate.toFixed(1) + '%' : '--';

  let rentalSection = '';
  if (hasRental) {
    rentalSection = `
    <div style="border-top:1px solid #2a2a2a;margin-top:8px;padding-top:8px;">
      <div style="font-size:10px;font-weight:700;color:#c8a84e;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;">Rental Analysis</div>
      <div class="popup-row">
        <span class="popup-label">Beds / Baths</span>
        <span class="popup-value">${prop.beds}br / ${prop.baths || '--'}ba${prop.sqft ? ' / ' + Number(prop.sqft).toLocaleString() + ' sqft' : ''}</span>
      </div>
      <div class="popup-row">
        <span class="popup-label">Rent Type</span>
        <span class="popup-value">${rentTypeLabel}</span>
      </div>
      <div class="popup-row">
        <span class="popup-label">Monthly Rent</span>
        <span class="popup-value">${activeRentFmt}</span>
      </div>
      <div class="popup-row">
        <span class="popup-label">Monthly NOI</span>
        <span class="popup-value" style="color:${noiColor};font-weight:700;">${noiFmt}</span>
      </div>
      <div class="popup-row">
        <span class="popup-label">Cap Rate</span>
        <span class="popup-value">${capFmt}</span>
      </div>
    </div>`;
  }

  marker.bindPopup(`
    <div class="popup-title">${prop.address || 'Unnamed Property'}</div>
    <div style="font-size:10px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;">Deal Analysis</div>
    <div class="popup-row">
      <span class="popup-label">List Price</span>
      <span class="popup-value">${fmtPrice}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">ARV</span>
      <span class="popup-value">${fmtARV}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">Rehab</span>
      <span class="popup-value">${fmtRehab}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">% of ARV</span>
      <span class="popup-value" style="color:${color}; font-weight:700;">${prop.arvPct.toFixed(1)}% -- ${getARVLabel(prop.arvPct)}</span>
    </div>
    <div class="popup-row">
      <span class="popup-label">Spread</span>
      <span class="popup-value">${spread}</span>
    </div>
    ${prop.notes ? `<div style="margin-top:8px;font-size:11px;color:#888;border-top:1px solid #2a2a2a;padding-top:6px;">${prop.notes}</div>` : ''}
    ${rentalSection}
    <button onclick="editProperty(${index})" style="
      margin-top:10px;
      background:#c8a84e;
      color:#0a0a0a;
      border:none;
      padding:6px 12px;
      border-radius:4px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      font-family:'Inter',sans-serif;
      margin-right:6px;
    ">Edit</button>
    <button onclick="deleteProperty(${index})" style="
      margin-top:10px;
      background:transparent;
      color:#ff5252;
      border:1px solid #ff5252;
      padding:6px 12px;
      border-radius:4px;
      font-size:11px;
      cursor:pointer;
      font-family:'Inter',sans-serif;
    ">Delete</button>
  `, { maxWidth: 350 }).bindTooltip(`${prop.address || 'Property'} (${prop.arvPct.toFixed(0)}%${hasRental ? ' | NOI: ' + noiFmt : ''})`);

  return marker;
}

function renderProperties() {
  propertyPinsLayer.clearLayers();
  const filter = document.getElementById('arvFilter').value;

  properties.forEach((prop, i) => {
    let show = true;
    if (filter === 'green' && prop.arvPct > 50) show = false;
    if (filter === 'yellow' && (prop.arvPct <= 50 || prop.arvPct > 65)) show = false;
    if (filter === 'orange' && (prop.arvPct <= 65 || prop.arvPct > 70)) show = false;
    if (filter === 'red' && prop.arvPct <= 70) show = false;
    if (filter === 'deals' && prop.arvPct > 65) show = false;

    if (show) {
      const marker = createPropertyMarker(prop, i);
      marker.addTo(propertyPinsLayer);
    }
  });
}

function showPropertyForm(lat, lng, existingProp, existingIndex) {
  const isEdit = existingProp !== undefined;
  const p = existingProp || {};

  const popup = L.popup({ maxWidth: 400, maxHeight: 600, closeOnClick: false, autoClose: false })
    .setLatLng([lat, lng])
    .setContent(`
      <div class="prop-form" id="propForm">
        <div class="popup-title">${isEdit ? 'Edit' : 'Add'} Property Pin</div>

        <div class="section-label">Deal Analysis</div>
        <label>Address</label>
        <input type="text" id="pf_address" value="${p.address || ''}" placeholder="123 Street NW, Atlanta, GA 30318" oninput="detectZipFromAddress()" />
        <label>List Price ($)</label>
        <input type="number" id="pf_price" value="${p.price || ''}" placeholder="150000" oninput="calcARV(); calcRentalSummary();" />
        <label>ARV Estimate ($)</label>
        <input type="number" id="pf_arv" value="${p.arv || ''}" placeholder="250000" oninput="calcARV()" />
        <label>Rehab Estimate ($)</label>
        <input type="number" id="pf_rehab" value="${p.rehab || ''}" placeholder="40000" oninput="calcARV(); calcRentalSummary();" />
        <label>% of ARV</label>
        <div class="arv-display" id="pf_arvDisplay">--</div>
        <label>Notes</label>
        <textarea id="pf_notes" placeholder="Motivation, condition, etc.">${p.notes || ''}</textarea>

        <hr class="section-divider" />
        <div class="section-label">Rental Analysis</div>

        <div class="grid-3col">
          <div class="grid-cell">
            <label>Bedrooms</label>
            <select id="pf_beds" onchange="updateRentEstimates(); calcRentalSummary();">
              <option value="">--</option>
              <option value="1" ${p.beds == 1 ? 'selected' : ''}>1</option>
              <option value="2" ${p.beds == 2 ? 'selected' : ''}>2</option>
              <option value="3" ${p.beds == 3 ? 'selected' : ''}>3</option>
              <option value="4" ${p.beds == 4 ? 'selected' : ''}>4</option>
              <option value="5" ${p.beds == 5 ? 'selected' : ''}>5</option>
            </select>
          </div>
          <div class="grid-cell">
            <label>Bathrooms</label>
            <select id="pf_baths" onchange="calcRentalSummary();">
              <option value="">--</option>
              <option value="1" ${p.baths == 1 ? 'selected' : ''}>1</option>
              <option value="1.5" ${p.baths == 1.5 ? 'selected' : ''}>1.5</option>
              <option value="2" ${p.baths == 2 ? 'selected' : ''}>2</option>
              <option value="2.5" ${p.baths == 2.5 ? 'selected' : ''}>2.5</option>
              <option value="3" ${p.baths == 3 ? 'selected' : ''}>3</option>
            </select>
          </div>
          <div class="grid-cell">
            <label>Sq Ft</label>
            <input type="number" id="pf_sqft" value="${p.sqft || ''}" placeholder="1400" />
          </div>
        </div>

        <label>Rent Type</label>
        <select id="pf_rentType" onchange="updateRentEstimates(); calcRentalSummary();">
          <option value="market" ${p.rentType === 'market' ? 'selected' : ''}>Market Rate</option>
          <option value="s8" ${p.rentType === 's8' ? 'selected' : ''}>Section 8</option>
          <option value="both" ${p.rentType === 'both' ? 'selected' : ''}>Both (compare)</option>
        </select>

        <div id="pf_zipInfo" style="font-size:10px;color:var(--text-dim);margin-top:4px;display:none;">
          ZIP detected: <span id="pf_zipDisplay" style="color:var(--gold);font-weight:600;">--</span> (SAFMR rates applied)
        </div>

        <div class="grid-2col">
          <div class="grid-cell">
            <label>Monthly Rent (Market)</label>
            <input type="number" id="pf_rentMarket" value="${p.rentMarket || ''}" placeholder="auto" oninput="calcRentalSummary();" />
          </div>
          <div class="grid-cell">
            <label>Monthly Rent (S8)</label>
            <input type="number" id="pf_rentS8" value="${p.rentS8 || ''}" placeholder="auto" oninput="calcRentalSummary();" />
          </div>
        </div>

        <div class="rental-summary" id="rentalSummary" style="display:none;">
          <div class="rs-title">Cash Flow Projection</div>
          <div id="rentalSummaryContent">--</div>
        </div>

        <div class="form-actions">
          <button class="btn-save" onclick="savePropertyForm(${lat}, ${lng}, ${isEdit ? existingIndex : -1})">${isEdit ? 'Update' : 'Save Pin'}</button>
          <button class="btn-cancel" onclick="cancelPropertyForm()">Cancel</button>
        </div>
      </div>
    `)
    .openOn(map);

  tempMarker = popup;
  setTimeout(() => {
    calcARV();
    detectZipFromAddress();
    updateRentEstimates();
    calcRentalSummary();
  }, 100);
}

window.calcARV = function() {
  const price = parseFloat(document.getElementById('pf_price')?.value);
  const arv = parseFloat(document.getElementById('pf_arv')?.value);
  const display = document.getElementById('pf_arvDisplay');
  if (!display) return;

  if (price && arv && arv > 0) {
    const pct = (price / arv) * 100;
    const color = getARVColor(pct);
    display.innerHTML = `<span style="color:${color}; font-weight:700;">${pct.toFixed(1)}%</span> <span style="color:#888; font-size:11px;">-- ${getARVLabel(pct)}</span>`;
  } else {
    display.textContent = '--';
  }
};

// Track detected ZIP for SAFMR lookup
let detectedZip = '';

window.detectZipFromAddress = function() {
  const addr = document.getElementById('pf_address')?.value || '';
  const zipMatch = addr.match(/\b(3\d{4})\b/);
  const zipInfo = document.getElementById('pf_zipInfo');
  const zipDisplay = document.getElementById('pf_zipDisplay');

  if (zipMatch && SAFMR_BY_ZIP[zipMatch[1]]) {
    detectedZip = zipMatch[1];
    if (zipInfo) zipInfo.style.display = 'block';
    if (zipDisplay) zipDisplay.textContent = detectedZip;
    updateRentEstimates();
    calcRentalSummary();
  } else {
    detectedZip = '';
    if (zipInfo) zipInfo.style.display = 'none';
  }
};

window.updateRentEstimates = function() {
  const beds = parseInt(document.getElementById('pf_beds')?.value) || 0;
  const marketInput = document.getElementById('pf_rentMarket');
  const s8Input = document.getElementById('pf_rentS8');
  if (!marketInput || !s8Input) return;

  // Only auto-fill if the field is empty or was previously auto-filled
  if (beds > 0) {
    if (!marketInput.value || marketInput.dataset.auto === 'true') {
      marketInput.value = MARKET_RENT[beds] || '';
      marketInput.dataset.auto = 'true';
    }

    // Use SAFMR if ZIP detected, otherwise use metro FMR
    let s8Rate;
    if (detectedZip && SAFMR_BY_ZIP[detectedZip]) {
      s8Rate = SAFMR_BY_ZIP[detectedZip][beds];
    } else {
      s8Rate = SECTION_8_FMR[beds];
    }
    if (!s8Input.value || s8Input.dataset.auto === 'true') {
      s8Input.value = s8Rate || '';
      s8Input.dataset.auto = 'true';
    }
  }
};

// Mark field as manually edited when user types
document.addEventListener('input', function(e) {
  if (e.target.id === 'pf_rentMarket' || e.target.id === 'pf_rentS8') {
    e.target.dataset.auto = 'false';
  }
});

window.calcRentalCashFlow = function(grossRent, rentType, price, rehab) {
  if (!grossRent || grossRent <= 0) return null;

  const isS8 = rentType === 's8';
  const vacancyRate = isS8 ? RENTAL_DEFAULTS.vacancyS8 : RENTAL_DEFAULTS.vacancyMarket;
  const vacancy = grossRent * vacancyRate;
  const effectiveRent = grossRent - vacancy;
  const mgmt = effectiveRent * RENTAL_DEFAULTS.management;
  const insurance = RENTAL_DEFAULTS.insurance;
  const taxes = RENTAL_DEFAULTS.taxes;
  const maintenance = effectiveRent * RENTAL_DEFAULTS.maintenance;

  const totalExpenses = vacancy + mgmt + insurance + taxes + maintenance;
  const monthlyNOI = grossRent - totalExpenses;
  const annualNOI = monthlyNOI * 12;

  let capRate = null;
  let cashOnCash = null;
  if (price && price > 0) {
    capRate = (annualNOI / price) * 100;
  }
  if (price && price > 0 && rehab !== undefined) {
    const totalInvested = price + (rehab || 0);
    if (totalInvested > 0) {
      cashOnCash = (annualNOI / totalInvested) * 100;
    }
  }

  return {
    grossRent,
    vacancy,
    vacancyRate,
    effectiveRent,
    mgmt,
    insurance,
    taxes,
    maintenance,
    totalExpenses,
    monthlyNOI,
    annualNOI,
    capRate,
    cashOnCash
  };
};

window.calcRentalSummary = function() {
  const summaryDiv = document.getElementById('rentalSummary');
  const contentDiv = document.getElementById('rentalSummaryContent');
  if (!summaryDiv || !contentDiv) return;

  const rentType = document.getElementById('pf_rentType')?.value || 'market';
  const marketRent = parseFloat(document.getElementById('pf_rentMarket')?.value) || 0;
  const s8Rent = parseFloat(document.getElementById('pf_rentS8')?.value) || 0;
  const price = parseFloat(document.getElementById('pf_price')?.value) || 0;
  const rehab = parseFloat(document.getElementById('pf_rehab')?.value) || 0;

  if (!marketRent && !s8Rent) {
    summaryDiv.style.display = 'none';
    return;
  }

  summaryDiv.style.display = 'block';
  let html = '';

  function renderBlock(label, cf, typeLabel) {
    if (!cf) return '';
    const noiColor = cf.monthlyNOI >= 0 ? 'var(--gold)' : 'var(--red)';
    let block = `
      ${typeLabel ? `<div style="font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;margin-top:6px;">${typeLabel}</div>` : ''}
      <div class="rs-row"><span class="rs-label">Gross Rent</span><span class="rs-value">$${cf.grossRent.toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Vacancy (${(cf.vacancyRate*100).toFixed(0)}%)</span><span class="rs-value" style="color:var(--red);">-$${Math.round(cf.vacancy).toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Mgmt (10%)</span><span class="rs-value" style="color:var(--red);">-$${Math.round(cf.mgmt).toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Insurance</span><span class="rs-value" style="color:var(--red);">-$${cf.insurance.toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Taxes</span><span class="rs-value" style="color:var(--red);">-$${cf.taxes.toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Maint (5%)</span><span class="rs-value" style="color:var(--red);">-$${Math.round(cf.maintenance).toLocaleString()}</span></div>
      <div class="rs-row rs-highlight"><span class="rs-label">Monthly NOI</span><span class="rs-value" style="color:${noiColor};font-size:13px;">$${Math.round(cf.monthlyNOI).toLocaleString()}</span></div>
      <div class="rs-row"><span class="rs-label">Annual NOI</span><span class="rs-value" style="color:${noiColor};">$${Math.round(cf.annualNOI).toLocaleString()}</span></div>`;
    if (cf.capRate !== null) {
      const capColor = cf.capRate >= 8 ? 'var(--green)' : cf.capRate >= 5 ? 'var(--gold)' : 'var(--red)';
      block += `<div class="rs-row"><span class="rs-label">Cap Rate</span><span class="rs-value" style="color:${capColor};">${cf.capRate.toFixed(1)}%</span></div>`;
    }
    if (cf.cashOnCash !== null) {
      const cocColor = cf.cashOnCash >= 10 ? 'var(--green)' : cf.cashOnCash >= 6 ? 'var(--gold)' : 'var(--red)';
      block += `<div class="rs-row"><span class="rs-label">Cash-on-Cash</span><span class="rs-value" style="color:${cocColor};">${cf.cashOnCash.toFixed(1)}%</span></div>`;
    }
    return block;
  }

  if (rentType === 'market' && marketRent > 0) {
    const cf = calcRentalCashFlow(marketRent, 'market', price, rehab);
    html = renderBlock('Market Rate', cf, null);
  } else if (rentType === 's8' && s8Rent > 0) {
    const cf = calcRentalCashFlow(s8Rent, 's8', price, rehab);
    html = renderBlock('Section 8', cf, null);
  } else if (rentType === 'both') {
    if (marketRent > 0) {
      const cf1 = calcRentalCashFlow(marketRent, 'market', price, rehab);
      html += renderBlock('Market Rate', cf1, 'Market Rate');
    }
    if (s8Rent > 0) {
      const cf2 = calcRentalCashFlow(s8Rent, 's8', price, rehab);
      html += renderBlock('Section 8', cf2, 'Section 8');
    }
  }

  contentDiv.innerHTML = html || '<span style="color:var(--text-dim);">Enter bedrooms to see projections</span>';
};

window.savePropertyForm = function(lat, lng, editIndex) {
  const address = document.getElementById('pf_address').value;
  const price = parseFloat(document.getElementById('pf_price').value) || 0;
  const arv = parseFloat(document.getElementById('pf_arv').value) || 0;
  const rehab = parseFloat(document.getElementById('pf_rehab').value) || 0;
  const notes = document.getElementById('pf_notes').value;
  const arvPct = arv > 0 ? (price / arv) * 100 : 100;

  // Rental fields
  const beds = parseFloat(document.getElementById('pf_beds').value) || 0;
  const baths = parseFloat(document.getElementById('pf_baths').value) || 0;
  const sqft = parseFloat(document.getElementById('pf_sqft').value) || 0;
  const rentType = document.getElementById('pf_rentType').value;
  const rentMarket = parseFloat(document.getElementById('pf_rentMarket').value) || 0;
  const rentS8 = parseFloat(document.getElementById('pf_rentS8').value) || 0;

  // Calculate NOI for storage
  let monthlyNOI = 0;
  let annualNOI = 0;
  let capRate = null;
  let activeRent = 0;

  if (rentType === 's8' && rentS8 > 0) {
    const cf = calcRentalCashFlow(rentS8, 's8', price, rehab);
    if (cf) { monthlyNOI = cf.monthlyNOI; annualNOI = cf.annualNOI; capRate = cf.capRate; activeRent = rentS8; }
  } else if (rentMarket > 0) {
    const cf = calcRentalCashFlow(rentMarket, 'market', price, rehab);
    if (cf) { monthlyNOI = cf.monthlyNOI; annualNOI = cf.annualNOI; capRate = cf.capRate; activeRent = rentMarket; }
  }

  const propData = {
    lat, lng, address, price, arv, rehab, arvPct, notes,
    beds, baths, sqft, rentType, rentMarket, rentS8,
    monthlyNOI, annualNOI, capRate, activeRent,
    created: new Date().toISOString()
  };

  if (editIndex >= 0) {
    properties[editIndex] = { ...properties[editIndex], ...propData };
  } else {
    properties.push(propData);
  }

  saveProperties();
  renderProperties();
  map.closePopup();
  tempMarker = null;

  if (addMode) toggleAddMode();
};

window.cancelPropertyForm = function() {
  map.closePopup();
  tempMarker = null;
  if (addMode) toggleAddMode();
};

window.editProperty = function(index) {
  const p = properties[index];
  map.closePopup();
  setTimeout(() => showPropertyForm(p.lat, p.lng, p, index), 100);
};

window.deleteProperty = function(index) {
  if (confirm('Delete this property pin?')) {
    properties.splice(index, 1);
    saveProperties();
    renderProperties();
    map.closePopup();
  }
};

function toggleAddMode() {
  addMode = !addMode;
  const banner = document.getElementById('addModeBanner');
  const btn = document.getElementById('btnAddProperty');

  if (addMode) {
    banner.classList.add('active');
    btn.textContent = 'Cancel';
    btn.style.background = '#ff5252';
    btn.style.borderColor = '#ff5252';
    map.getContainer().style.cursor = 'crosshair';
  } else {
    banner.classList.remove('active');
    btn.textContent = '+ Add Property';
    btn.style.background = '';
    btn.style.borderColor = '';
    map.getContainer().style.cursor = '';
    if (tempMarker) {
      map.closePopup();
      tempMarker = null;
    }
  }
}

map.on('click', function(e) {
  if (!addMode) return;
  showPropertyForm(e.latlng.lat, e.latlng.lng);
});

propertyPinsLayer.addTo(map);
renderProperties();


// ============================================
// ADDRESS SEARCH + GEOCODING
// ============================================

window.searchAddress = async function() {
  const query = document.getElementById('addressSearch').value.trim();
  if (!query) return;

  const results = document.getElementById('searchResults');
  results.innerHTML = '<div class="search-loading">Searching...</div>';
  results.classList.add('active');

  try {
    // Append Atlanta GA if not already specified to bias results
    const searchQuery = query.toLowerCase().includes('atlanta') ? query : query + ', Atlanta, GA';
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&countrycodes=us&viewbox=-84.55,33.80,-84.35,33.68&bounded=0`;

    const resp = await fetch(url, {
      headers: { 'User-Agent': 'Rhino8-InvestmentMap/1.0' }
    });
    const data = await resp.json();

    if (data.length === 0) {
      results.innerHTML = '<div class="search-loading">No results found. Try a more specific address.</div>';
      setTimeout(() => results.classList.remove('active'), 3000);
      return;
    }

    results.innerHTML = '';
    data.forEach((item, idx) => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.textContent = item.display_name;
      div.onclick = () => selectSearchResult(item);
      results.appendChild(div);
    });

  } catch (err) {
    results.innerHTML = '<div class="search-loading">Search failed. Check your connection.</div>';
    setTimeout(() => results.classList.remove('active'), 3000);
  }
};

window.selectSearchResult = function(item) {
  const lat = parseFloat(item.lat);
  const lng = parseFloat(item.lon);

  // Close search results
  document.getElementById('searchResults').classList.remove('active');

  // Fly to location
  map.flyTo([lat, lng], 17, { duration: 1.2 });

  // Auto-fill the address and open the property form
  setTimeout(() => {
    showPropertyForm(lat, lng);
    // Pre-fill the address field after popup renders
    setTimeout(() => {
      const addrField = document.getElementById('pf_address');
      if (addrField) {
        // Extract short address from display_name
        const parts = item.display_name.split(',');
        addrField.value = parts.slice(0, 3).join(',').trim();
        // Trigger ZIP detection from the full display name
        detectZipFromAddress();
        // Also try to detect ZIP from full display_name if not found in short address
        if (!detectedZip) {
          const fullZipMatch = item.display_name.match(/\b(3\d{4})\b/);
          if (fullZipMatch && SAFMR_BY_ZIP[fullZipMatch[1]]) {
            detectedZip = fullZipMatch[1];
            const zipInfo = document.getElementById('pf_zipInfo');
            const zipDisplay = document.getElementById('pf_zipDisplay');
            if (zipInfo) zipInfo.style.display = 'block';
            if (zipDisplay) zipDisplay.textContent = detectedZip;
            updateRentEstimates();
            calcRentalSummary();
          }
        }
      }
    }, 200);
  }, 800);
};

// Close search results when clicking elsewhere
document.addEventListener('click', function(e) {
  const wrapper = document.querySelector('.search-wrapper');
  if (wrapper && !wrapper.contains(e.target)) {
    document.getElementById('searchResults').classList.remove('active');
  }
});

// ============================================
// LAYER CONTROL
// ============================================

const overlays = {
  "Investment Zone Boundary": investmentZoneLayer,
  "Interstate Highways": interstateLayer,
  "BeltLine Trails": beltlineLayer,
  "Parks & Green Spaces": parksLayer,
  "Proximity Rings": ringsLayer,
  "Opportunity Zones": ozLayer,
  "Known Developments": developmentLayer,
  "MARTA Stations": martaLayer,
  "My Properties": myPropertiesLayer,
  "Property Pins": propertyPinsLayer
};

L.control.layers(null, overlays, {
  position: 'topright',
  collapsed: true
}).addTo(map);


// ============================================
// INVESTMENT ZONE SCORE (hover)
// ============================================

const infoPanel = document.getElementById('infoPanel');
const infoPark = document.getElementById('infoPark');
const infoParkDist = document.getElementById('infoParkDist');
const infoBeltDist = document.getElementById('infoBeltDist');
const infoMarta = document.getElementById('infoMarta');
const infoMartaDist = document.getElementById('infoMartaDist');
const infoOZ = document.getElementById('infoOZ');
const infoInZone = document.getElementById('infoInZone');
const scoreFill = document.getElementById('scoreFill');
const scoreLabel = document.getElementById('scoreLabel');

function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 3958.8; // miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function distToPolyline(lat, lng, coords) {
  let minDist = Infinity;
  coords.forEach(c => {
    const d = haversineDistance(lat, lng, c[0], c[1]);
    if (d < minDist) minDist = d;
  });
  return minDist;
}

function isInOZ(lat, lng) {
  for (const oz of OZ_ZONES) {
    if (pointInPolygon(lat, lng, oz.coords)) return oz.name;
  }
  return null;
}

function pointInPolygon(lat, lng, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const yi = polygon[i][0], xi = polygon[i][1];
    const yj = polygon[j][0], xj = polygon[j][1];
    if (((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi)) {
      inside = !inside;
    }
  }
  return inside;
}

function isInInvestmentZone(lat, lng) {
  return pointInPolygon(lat, lng, INVESTMENT_ZONE);
}

function formatDistance(miles) {
  if (miles < 0.1) {
    return Math.round(miles * FEET_PER_MILE) + ' ft';
  }
  return miles.toFixed(2) + ' mi';
}

function calcInvestmentScore(parkDist, beltDist, martaDist, inOZ, inZone) {
  let score = 0;

  // Park proximity (max 25 pts)
  if (parkDist <= 0.25) score += 25;
  else if (parkDist <= 0.5) score += 20;
  else if (parkDist <= 1.0) score += 13;
  else if (parkDist <= 1.5) score += 6;

  // Beltline proximity (max 30 pts)
  if (beltDist <= 0.25) score += 30;
  else if (beltDist <= 0.5) score += 24;
  else if (beltDist <= 1.0) score += 15;
  else if (beltDist <= 1.5) score += 8;

  // MARTA proximity (max 20 pts)
  if (martaDist <= 0.25) score += 20;
  else if (martaDist <= 0.5) score += 16;
  else if (martaDist <= 1.0) score += 10;
  else if (martaDist <= 1.5) score += 5;

  // OZ bonus (15 pts)
  if (inOZ) score += 15;

  // Inside investment zone (10 pts)
  if (inZone) score += 10;

  return score;
}

let hoverTimeout;

map.on('mousemove', function(e) {
  clearTimeout(hoverTimeout);
  hoverTimeout = setTimeout(() => {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Nearest park
    let nearestPark = null;
    let nearestParkDist = Infinity;
    PARKS.forEach(p => {
      const d = haversineDistance(lat, lng, p.lat, p.lng);
      if (d < nearestParkDist) {
        nearestParkDist = d;
        nearestPark = p.name;
      }
    });

    // Distance to Beltline
    const beltDist = distToPolyline(lat, lng, ALL_BELTLINE_COORDS);

    // Nearest MARTA station
    let nearestMarta = null;
    let nearestMartaDist = Infinity;
    MARTA_STATIONS.forEach(s => {
      const d = haversineDistance(lat, lng, s.lat, s.lng);
      if (d < nearestMartaDist) {
        nearestMartaDist = d;
        nearestMarta = s.name.replace(' Station', '');
      }
    });

    // OZ check
    const ozName = isInOZ(lat, lng);

    // Investment zone check
    const inZone = isInInvestmentZone(lat, lng);

    // Investment score
    const score = calcInvestmentScore(nearestParkDist, beltDist, nearestMartaDist, ozName, inZone);

    // Update panel
    infoPark.textContent = nearestPark || '--';
    infoParkDist.textContent = formatDistance(nearestParkDist);
    infoBeltDist.textContent = formatDistance(beltDist);
    infoMarta.textContent = nearestMarta || '--';
    infoMartaDist.textContent = formatDistance(nearestMartaDist);
    infoOZ.textContent = ozName || 'No';
    infoOZ.style.color = ozName ? '#00e676' : '#ff5252';
    infoInZone.textContent = inZone ? 'Yes' : 'No';
    infoInZone.style.color = inZone ? '#00e676' : '#ff5252';

    scoreFill.style.width = score + '%';
    let scoreColor;
    if (score >= 80) scoreColor = '#00e676';
    else if (score >= 60) scoreColor = '#ffd740';
    else if (score >= 40) scoreColor = '#ff9100';
    else scoreColor = '#ff5252';
    scoreFill.style.background = `linear-gradient(90deg, ${scoreColor}, ${scoreColor}88)`;

    let scoreText;
    if (score >= 80) scoreText = 'Premium Zone';
    else if (score >= 60) scoreText = 'Strong Zone';
    else if (score >= 40) scoreText = 'Good Zone';
    else if (score >= 20) scoreText = 'Moderate Zone';
    else scoreText = 'Low Priority';

    scoreLabel.textContent = `${score}/100 -- ${scoreText}`;
    scoreLabel.style.color = scoreColor;

    infoPanel.classList.add('active');
  }, 50);
});

map.on('mouseout', function() {
  clearTimeout(hoverTimeout);
  infoPanel.classList.remove('active');
});


// ============================================
// UI FUNCTIONS
// ============================================

function toggleFilter() {
  const panel = document.getElementById('filterPanel');
  panel.classList.toggle('active');
}

function applyFilter() {
  renderProperties();
}

function updateStats() {
  const total = properties.length;
  const deals = properties.filter(p => p.arvPct <= 65).length;
  const avgARV = total > 0 ? (properties.reduce((s, p) => s + p.arvPct, 0) / total).toFixed(1) + '%' : '--';

  // Rental stats
  const rentalProps = properties.filter(p => p.activeRent && p.activeRent > 0);
  const totalMonthlyRent = rentalProps.reduce((s, p) => s + (p.activeRent || 0), 0);
  const totalAnnualNOI = rentalProps.reduce((s, p) => s + (p.annualNOI || 0), 0);
  const avgNOI = rentalProps.length > 0 ? totalAnnualNOI / rentalProps.length / 12 : 0;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statDeals').textContent = deals;
  document.getElementById('statAvgARV').textContent = avgARV;

  const statMonthlyRent = document.getElementById('statMonthlyRent');
  const statAvgNOI = document.getElementById('statAvgNOI');
  const statAnnualNOI = document.getElementById('statAnnualNOI');

  if (rentalProps.length > 0) {
    statMonthlyRent.textContent = '$' + totalMonthlyRent.toLocaleString();
    statAvgNOI.textContent = '$' + Math.round(avgNOI).toLocaleString();
    statAvgNOI.style.color = avgNOI >= 0 ? 'var(--gold)' : 'var(--red)';
    statAnnualNOI.textContent = '$' + Math.round(totalAnnualNOI).toLocaleString();
    statAnnualNOI.style.color = totalAnnualNOI >= 0 ? 'var(--gold)' : 'var(--red)';
  } else {
    statMonthlyRent.textContent = '--';
    statAvgNOI.textContent = '--';
    statAnnualNOI.textContent = '--';
  }

  document.getElementById('statParks').textContent = PARKS.length;
  document.getElementById('statOZ').textContent = OZ_ZONES.length;
  document.getElementById('statMarta').textContent = MARTA_STATIONS.length;
}

function exportProperties() {
  if (properties.length === 0) {
    alert('No properties to export. Add some pins first.');
    return;
  }

  let csv = 'Address,Latitude,Longitude,List Price,ARV,Rehab,% of ARV,Bedrooms,Bathrooms,Sq Ft,Rent Type,Market Rent,S8 Rent,Monthly NOI,Annual NOI,Cap Rate,Notes,Date Added\n';
  properties.forEach(p => {
    csv += `"${p.address || ''}",${p.lat},${p.lng},${p.price || ''},${p.arv || ''},${p.rehab || ''},${p.arvPct.toFixed(1)}%,${p.beds || ''},${p.baths || ''},${p.sqft || ''},"${p.rentType || ''}",${p.rentMarket || ''},${p.rentS8 || ''},${p.monthlyNOI !== undefined ? Math.round(p.monthlyNOI) : ''},${p.annualNOI !== undefined ? Math.round(p.annualNOI) : ''},${p.capRate !== undefined && p.capRate !== null ? p.capRate.toFixed(1) + '%' : ''},"${(p.notes || '').replace(/"/g, '""')}",${p.created || ''}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rhino8_properties_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Initial stats
updateStats();


// ============================================
// KEYBOARD SHORTCUTS
// ============================================

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (addMode) toggleAddMode();
    const fp = document.getElementById('filterPanel');
    if (fp.classList.contains('active')) toggleFilter();
  }
  if (e.key === 'a' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
    toggleAddMode();
  }
  if (e.key === 'f' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
    toggleFilter();
  }
  if (e.key === 's' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'SELECT') {
    e.preventDefault();
    document.getElementById('addressSearch').focus();
  }
});

</script>
</body>
</html>
